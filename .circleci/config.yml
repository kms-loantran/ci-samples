version: 2.1

# parameters:
#   kre-image-tag:
#     type: string
#     default: "latest"
#   agent-download-link:
#     type: string
#     default: ""
#   job-info:
#     type: string
#     default: ""
#   agent-config:
#     type: string
#     default: ""

jobs:
  build:
    parameters:
      ks_version:
        type: string
        default: "latest"
      agent_download_link:
        type: string
        default: ""
      job_info:
        type: string
        default: ""
      agent_config:
        type: string
        default: ""
    docker:
      - image: katalonstudio/katalon:<< parameters.KS_VERSION >>
    environment:
      AGENT_DOWNLOAD_LINK: << parameters.AGENT_DOWNLOAD_LINK >>
      JOB_INFO: << parameters.JOB_INFO >>
      AGENT_CONFIG:  << parameters.AGENT_CONFIG >>
    steps:
      - run:
          name: Execute test
          command: |
            set -x
            set -o nounset

            printenv

            mkdir /agent

            cd /agent

            wget -O agent "${AGENT_DOWNLOAD_LINK}"
            echo "${JOB_INFO}" >> job.json
            echo "${AGENT_CONFIG}" >> agentconfig

            chmod 777 *
            ls -al

            ./agent start-agent --ci